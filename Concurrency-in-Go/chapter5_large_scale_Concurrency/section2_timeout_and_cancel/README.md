# 5.2 タイムアウトとキャンセル処理

> 並行処理のプロセスに __タイムアウト__ をサポートしてもらいたい理由とは何でしょうか。いくつか挙げてみます。

* システム飽和状態
* 新鮮ではないデータ
* デッドロックを防ぐ仕組み
* セクションのまとめ

> __キャンセル__ される理由はいくつもあります。

* タイムアウト

タイムアウトは暗黙的なキャンセルです。

* ユーザーによる介入

ユーザーに面したところで並行処理の操作をする場合、ときにはユーザーに起動した処理をキャンセルできるようにさせることも必要になります。

* 親のキャンセル

並行処理の親が停止されたら、その子供はキャンセルされます。

* 複製されたリクエスト

複数の並行処理のプロセスに、そのうちどれかが早くレスポンスを返してくれることを望んで、複製したデータを送ることがあります。最初の1つが返ってきたときに、他のプロセスをキャンセルしたいと思うでしょう。

## 任意のタイミングで終了されうる並行処理のコードを書いているとき、何を考慮する必要があるでしょうか？

> 次のコードが1つのゴルーチンで実行されているとします。

```go
var value interface{}
select {
case <-done:
	return
case value = <-valueStream:
}

result := reallyLongCalculation(value)
select {
case <-done:
	return
case resultStream <- result:
}
```

問題点としては、reallyLongCalculation関数は名前からも非常に長そうですが、doneが渡っていないので、ランタイムの割り込みが可能でありません。

しかし、その reallyLongCalculation関数内にも longCalculation関数というのがあり、更にdoneを渡して割り込み可能にする必要があります。

```go
reallyLongCalculation := func(
	done <-chan interface{},
	value interface{},
) interface{} {
	intermediateResult := longCalculation(done, value)
	return longCalculation(done, intermediateResult)
}
```

(書籍ではわかりづらく説明しているが)、要は、処理が長くかかると想定される処理には`done`を渡してランタイムの割り込みを可能にしておこう、ということ。

> これを実現する最も簡単な方法は、ゴルーチンの中身を小さい機能に分割することです。すべての __ランタイムによる割り込みが可能でない__ アトミックな操作が、許容できる時間内で完了することを目指すべきです。

## リソースに対するロールバックの課題

> ここには別の問題点も潜んでいます。もしゴルーチンが偶然にも共有状態 ーー 例えばデータベース、ファイル、インメモリのデータ構造 ーー を変更してしまったら、そのゴルーチンがキャンセルされてしまった場合に何が起きるでしょうか。ゴルーチンは実行してしまった中間処理をロールバックしようとするでしょうか。何かがゴルーチンに停止せよと伝えたら、ロールバックに長い時間をかけないようにしないといけないですよね。

> この問題の扱いに関して一般的なアドバイスを与えるのは困難なことです。しかしながら、いかなる共有状態に対する変更も小さい範囲に留めるようにすること、こうした変更を容易にロールバックできるようにしておくこと、この2つのどちらかが1つあるいは両方行えばキャンセル処理を極めてうまく扱えます。可能であれば、中間処理の結果をメモリに入れて、状態をできる限り素早く修正します。例としてその間違った方法を載せます。

### Bad

```go
result := add(1, 2, 3)
writeTallyToState(result)
result = add(4, 5, 6)
writeTallyToState(result)
result = add(7, 8, 9)
writeTallyToState(result)
```

### Good

```go
result := add(1, 2, 3, 4, 5, 6, 7, 8, 9)
writeTallyToState(result)
```

> Goodのコードではロールバックを気にしなければいけない領域はずっと小さくなります。キャンセル処理がwriteTallyToStateへの呼び出しのあとに発生した場合、依然として変更を戻す方法は必要ですが、状態を一度しか変更していないため、これが起きる可能性はずっと小さいでしょう。

## 複製したメッセージ

>  これは5.3ハートビートの節で扱います。
